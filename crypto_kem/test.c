#include "api.h"
#include "randombytes.h"
#include "hal.h"

#include <string.h>

#define NTESTS 10

// https://stackoverflow.com/a/1489985/1711232
#define PASTER(x, y) x##y
#define EVALUATOR(x, y) PASTER(x, y)
#define NAMESPACE(fun) EVALUATOR(MUPQ_NAMESPACE, fun)

// use different names so we can have empty namespaces
#define MUPQ_CRYPTO_BYTES           NAMESPACE(CRYPTO_BYTES)
#define MUPQ_CRYPTO_PUBLICKEYBYTES  NAMESPACE(CRYPTO_PUBLICKEYBYTES)
#define MUPQ_CRYPTO_SECRETKEYBYTES  NAMESPACE(CRYPTO_SECRETKEYBYTES)
#define MUPQ_CRYPTO_CIPHERTEXTBYTES NAMESPACE(CRYPTO_CIPHERTEXTBYTES)
#define MUPQ_CRYPTO_ALGNAME NAMESPACE(CRYPTO_ALGNAME)

#define MUPQ_crypto_kem_keypair NAMESPACE(crypto_kem_keypair)
#define MUPQ_crypto_kem_enc NAMESPACE(crypto_kem_enc)
#define MUPQ_crypto_kem_dec NAMESPACE(crypto_kem_dec)

const uint8_t canary[8] = {
  0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF
};

/* allocate a bit more for all keys and messages and
 * make sure it is not touched by the implementations.
 */
static void write_canary(uint8_t *d) {
  for (size_t i = 0; i < 8; i++) {
    d[i] = canary[i];
  }
}

static int check_canary(const uint8_t *d) {
  for (size_t i = 0; i < 8; i++) {
    if (d[i] != canary[i]) {
      return -1;
    }
  }
  return 0;
}

static int test_keys(void)
{
  unsigned char key_a[MUPQ_CRYPTO_BYTES+16], key_b[MUPQ_CRYPTO_BYTES+16];
  unsigned char pk[MUPQ_CRYPTO_PUBLICKEYBYTES+16];
  unsigned char sendb[MUPQ_CRYPTO_CIPHERTEXTBYTES+16];
  unsigned char sk_a[MUPQ_CRYPTO_SECRETKEYBYTES+16];

  write_canary(key_a); write_canary(key_a+sizeof(key_a)-8);
  write_canary(key_b); write_canary(key_b+sizeof(key_b)-8);
  write_canary(pk); write_canary(pk+sizeof(pk)-8);
  write_canary(sendb); write_canary(sendb+sizeof(sendb)-8);
  write_canary(sk_a); write_canary(sk_a+sizeof(sk_a)-8);

  uint8_t pk_u[] = {1, 35, 69, 103, 137, 171, 205, 239, 116, 123, 10, 147, 122, 99, 39, 56, 126, 139, 229, 4, 143, 162, 187, 160, 139, 63, 110, 232, 5, 56, 107, 193, 109, 42, 39, 23, 80, 116, 121, 215, 196, 32, 9, 23, 86, 22, 32, 219, 197, 85, 117, 99, 195, 16, 102, 86, 163, 150, 4, 127, 119, 148, 92, 20, 145, 239, 197, 42, 63, 226, 150, 133, 167, 16, 5, 197, 80, 240, 101, 49, 237, 68, 109, 125, 19, 158, 194, 19, 27, 242, 148, 66, 49, 210, 95, 28, 150, 166, 117, 183, 52, 140, 198, 12, 238, 65, 76, 117, 249, 154, 135, 21, 134, 201, 113, 201, 76, 49, 182, 71, 202, 90, 137, 11, 135, 106, 149, 79, 19, 228, 91, 137, 41, 81, 223, 123, 178, 213, 181, 173, 67, 104, 79, 10, 89, 120, 32, 220, 111, 68, 232, 82, 142, 115, 94, 176, 150, 109, 220, 102, 2, 250, 4, 18, 86, 184, 105, 146, 21, 125, 230, 169, 158, 72, 133, 13, 50, 3, 138, 180, 208, 6, 42, 199, 103, 107, 37, 13, 243, 48, 36, 36, 105, 87, 113, 134, 11, 204, 246, 38, 174, 128, 36, 34, 185, 24, 158, 74, 99, 13, 44, 51, 15, 181, 57, 90, 177, 93, 134, 6, 42, 1, 22, 167, 142, 115, 1, 164, 53, 36, 245, 82, 200, 227, 163, 198, 235, 168, 0, 101, 38, 157, 30, 89, 199, 215, 172, 38, 116, 203, 50, 206, 114, 193, 93, 204, 120, 185, 245, 146, 36, 5, 79, 70, 16, 111, 32, 26, 94, 50, 185, 193, 191, 96, 147, 193, 9, 181, 182, 170, 63, 122, 219, 98, 185, 108, 10, 46, 7, 9, 39, 247, 15, 238, 81, 104, 209, 87, 154, 210, 115, 169, 254, 89, 188, 234, 24, 99, 11, 43, 135, 112, 219, 11, 208, 168, 87, 112, 208, 94, 53, 208, 37, 209, 216, 90, 188, 148, 101, 147, 252, 174, 104, 211, 0, 193, 169, 48, 35, 60, 38, 60, 113, 141, 171, 103, 206, 2, 101, 132, 32, 0, 143, 127, 145, 184, 188, 119, 156, 135, 27, 142, 27, 48, 141, 213, 182, 193, 84, 145, 99, 167, 117, 67, 141, 3, 146, 153, 137, 204, 130, 7, 7, 89, 9, 194, 202, 145, 35, 121, 6, 27, 207, 19, 140, 8, 150, 33, 206, 155, 207, 25, 3, 61, 246, 35, 160, 43, 208, 74, 44, 155, 180, 24, 17, 15, 192, 34, 33, 213, 167, 163, 227, 87, 100, 142, 164, 141, 208, 66, 105, 52, 27, 39, 255, 219, 19, 237, 129, 103, 0, 236, 16, 113, 58, 169, 51, 209, 73, 211, 164, 179, 134, 72, 63, 119, 144, 100, 207, 3, 143, 9, 251, 0, 102, 148, 48, 126, 16, 162, 48, 129, 139, 138, 133, 10, 72, 40, 79, 241, 0, 32, 196, 179, 71, 193, 24, 87, 188, 26, 203, 93, 140, 91, 129, 65, 53, 49, 69, 107, 218, 130, 141, 232, 147, 107, 222, 4, 168, 253, 219, 29, 32, 193, 188, 172, 249, 81, 6, 147, 120, 71, 56, 174, 33, 178, 83, 21, 92, 82, 77, 244, 188, 92, 54, 7, 246, 201, 8, 47, 50, 196, 221, 182, 60, 121, 165, 165, 19, 210, 86, 253, 43, 38, 140, 66, 67, 105, 236, 78, 63, 170, 38, 103, 19, 169, 107, 71, 37, 103, 112, 194, 175, 216, 198, 100, 27, 151, 48, 148, 11, 96, 233, 46, 206, 249, 50, 115, 140, 180, 138, 139, 15, 155, 224, 141, 146, 171, 9, 158, 54, 191, 141, 232, 190, 7, 37, 34, 41, 243, 9, 214, 26, 82, 108, 129, 167, 185, 90, 77, 242, 247, 39, 121, 145, 192, 33, 112, 53, 243, 140, 97, 201, 172, 45, 25, 136, 18, 85, 40, 112, 161, 226, 160, 12, 51, 5, 93, 69, 104, 218, 233, 42, 40, 176, 97, 150, 236, 75, 163, 236, 145, 3, 178, 195, 178, 27, 196, 255, 137, 117, 150, 21, 104, 106, 187, 85, 168, 219, 173, 239, 19, 120, 173, 216, 105, 97, 166, 188, 136, 17, 48, 181, 234, 5, 107, 178, 18, 19, 81, 164, 61, 50, 134, 104, 124, 128, 152, 234, 203, 199, 147, 50, 254, 182, 165, 112, 53, 161, 107, 201, 32, 73, 234, 172, 41, 116, 135, 220, 197, 163, 2, 36, 142, 81, 225, 53, 205, 252, 21, 179, 75, 113, 68, 32, 191, 42, 166, 178, 46, 200, 117, 103, 85, 94, 95, 162, 70, 40, 119, 153, 52, 37, 134, 22, 186, 60, 147, 69, 146, 115, 172, 200, 94, 42, 96, 31, 9, 125, 122, 23, 244, 69, 74, 119, 48, 186, 193, 230, 35, 185, 69, 148, 146, 248, 192, 35, 63, 242, 149, 142, 136, 245, 153, 111, 225, 121, 137, 1, 35, 69, 103, 137, 171, 205, 239};
  uint8_t sk_u[] = {1, 35, 69, 103, 137, 171, 205, 239, 65, 140, 115, 6, 213, 63, 237, 134, 1, 205, 3, 91, 33, 195, 51, 133, 42, 49, 114, 112, 41, 232, 59, 73, 188, 168, 78, 110, 183, 137, 153, 7, 137, 9, 76, 85, 222, 193, 114, 200, 55, 183, 172, 151, 171, 2, 38, 110, 84, 23, 127, 122, 57, 192, 94, 184, 70, 16, 193, 59, 154, 28, 32, 170, 90, 111, 190, 11, 35, 220, 101, 135, 78, 34, 149, 129, 251, 96, 188, 82, 120, 129, 38, 105, 211, 156, 129, 249, 53, 19, 39, 5, 131, 97, 203, 20, 205, 6, 195, 251, 164, 148, 63, 133, 1, 41, 146, 158, 29, 160, 69, 114, 39, 161, 239, 161, 2, 230, 52, 123, 120, 83, 168, 9, 91, 29, 6, 66, 177, 60, 43, 148, 3, 19, 122, 51, 162, 167, 240, 55, 29, 211, 163, 187, 146, 176, 93, 223, 86, 20, 13, 248, 27, 108, 246, 138, 199, 160, 131, 249, 64, 0, 62, 119, 193, 229, 12, 184, 244, 172, 202, 85, 120, 31, 189, 65, 172, 232, 171, 62, 72, 224, 9, 219, 231, 110, 226, 188, 156, 87, 201, 190, 189, 183, 151, 86, 70, 34, 130, 75, 92, 131, 101, 97, 169, 88, 139, 45, 3, 9, 94, 54, 191, 158, 132, 124, 30, 209, 201, 21, 201, 190, 26, 24, 193, 56, 135, 75, 121, 40, 158, 203, 248, 133, 228, 162, 94, 161, 160, 54, 27, 212, 203, 31, 68, 39, 182, 104, 136, 248, 106, 158, 146, 168, 13, 218, 165, 29, 0, 243, 73, 68, 169, 120, 151, 176, 195, 213, 55, 192, 148, 240, 133, 28, 224, 153, 57, 64, 79, 78, 2, 197, 56, 134, 157, 163, 145, 84, 232, 168, 54, 116, 16, 97, 192, 162, 156, 94, 247, 145, 52, 38, 137, 83, 86, 70, 101, 8, 19, 128, 18, 68, 186, 226, 189, 125, 71, 170, 134, 215, 43, 227, 184, 181, 70, 148, 153, 21, 148, 168, 84, 117, 105, 193, 16, 190, 255, 251, 11, 144, 228, 123, 82, 37, 19, 177, 58, 174, 191, 209, 109, 212, 8, 41, 106, 224, 162, 38, 198, 99, 202, 215, 48, 126, 228, 204, 254, 50, 145, 210, 192, 140, 155, 166, 4, 72, 130, 166, 122, 82, 184, 203, 21, 197, 250, 117, 133, 26, 170, 40, 187, 41, 121, 82, 65, 51, 117, 150, 119, 96, 108, 107, 120, 56, 15, 187, 83, 172, 240, 82, 1, 104, 146, 75, 1, 73, 93, 199, 167, 131, 227, 0, 119, 101, 231, 56, 167, 137, 8, 241, 0, 39, 139, 203, 190, 84, 210, 18, 242, 146, 118, 189, 145, 184, 26, 35, 26, 24, 246, 203, 46, 225, 193, 141, 137, 157, 49, 27, 145, 166, 130, 103, 167, 84, 85, 253, 49, 149, 16, 33, 149, 11, 115, 152, 236, 53, 154, 15, 27, 183, 49, 150, 64, 167, 123, 76, 117, 151, 104, 109, 89, 114, 111, 166, 162, 73, 81, 204, 91, 82, 5, 39, 236, 102, 62, 32, 143, 43, 67, 189, 112, 147, 178, 24, 114, 88, 208, 145, 156, 210, 2, 195, 121, 19, 61, 187, 169, 178, 156, 16, 39, 186, 10, 124, 191, 211, 36, 214, 132, 162, 35, 102, 185, 49, 32, 143, 146, 154, 170, 241, 117, 129, 166, 162, 167, 45, 8, 30, 36, 0, 100, 223, 41, 201, 53, 89, 201, 94, 203, 176, 166, 20, 156, 219, 251, 146, 198, 236, 17, 202, 225, 187, 254, 65, 84, 27, 49, 121, 70, 176, 44, 153, 74, 87, 121, 251, 151, 195, 66, 195, 112, 250, 36, 173, 155, 135, 135, 137, 87, 127, 76, 182, 58, 33, 197, 233, 250, 193, 246, 103, 191, 66, 130, 126, 21, 52, 61, 201, 217, 22, 174, 215, 101, 227, 85, 56, 39, 187, 150, 2, 144, 64, 98, 12, 147, 90, 118, 174, 106, 123, 3, 102, 60, 185, 39, 218, 192, 56, 154, 18, 54, 182, 49, 44, 114, 93, 75, 149, 112, 96, 4, 26, 100, 252, 80, 138, 82, 172, 17, 104, 191, 201, 161, 45, 242, 102, 6, 75, 231, 74, 247, 10, 187, 179, 103, 105, 176, 18, 141, 49, 104, 147, 193, 34, 129, 135, 248, 146, 141, 138, 137, 246, 131, 125, 170, 53, 175, 29, 247, 115, 250, 99, 18, 55, 119, 122, 111, 194, 138, 222, 50, 80, 94, 33, 196, 112, 35, 167, 138, 135, 24, 54, 180, 107, 234, 34, 153, 193, 146, 70, 213, 123, 59, 72, 108, 121, 107, 146, 108, 36, 36, 77, 192, 86, 112, 137, 243, 31, 116, 123, 10, 147, 122, 99, 39, 56, 126, 139, 229, 4, 143, 162, 187, 160, 139, 63, 110, 232, 5, 56, 107, 193, 109, 42, 39, 23, 80, 116, 121, 215, 196, 32, 9, 23, 86, 22, 32, 219, 197, 85, 117, 99, 195, 16, 102, 86, 163, 150, 4, 127, 119, 148, 92, 20, 145, 239, 197, 42, 63, 226, 150, 133, 167, 16, 5, 197, 80, 240, 101, 49, 237, 68, 109, 125, 19, 158, 194, 19, 27, 242, 148, 66, 49, 210, 95, 28, 150, 166, 117, 183, 52, 140, 198, 12, 238, 65, 76, 117, 249, 154, 135, 21, 134, 201, 113, 201, 76, 49, 182, 71, 202, 90, 137, 11, 135, 106, 149, 79, 19, 228, 91, 137, 41, 81, 223, 123, 178, 213, 181, 173, 67, 104, 79, 10, 89, 120, 32, 220, 111, 68, 232, 82, 142, 115, 94, 176, 150, 109, 220, 102, 2, 250, 4, 18, 86, 184, 105, 146, 21, 125, 230, 169, 158, 72, 133, 13, 50, 3, 138, 180, 208, 6, 42, 199, 103, 107, 37, 13, 243, 48, 36, 36, 105, 87, 113, 134, 11, 204, 246, 38, 174, 128, 36, 34, 185, 24, 158, 74, 99, 13, 44, 51, 15, 181, 57, 90, 177, 93, 134, 6, 42, 1, 22, 167, 142, 115, 1, 164, 53, 36, 245, 82, 200, 227, 163, 198, 235, 168, 0, 101, 38, 157, 30, 89, 199, 215, 172, 38, 116, 203, 50, 206, 114, 193, 93, 204, 120, 185, 245, 146, 36, 5, 79, 70, 16, 111, 32, 26, 94, 50, 185, 193, 191, 96, 147, 193, 9, 181, 182, 170, 63, 122, 219, 98, 185, 108, 10, 46, 7, 9, 39, 247, 15, 238, 81, 104, 209, 87, 154, 210, 115, 169, 254, 89, 188, 234, 24, 99, 11, 43, 135, 112, 219, 11, 208, 168, 87, 112, 208, 94, 53, 208, 37, 209, 216, 90, 188, 148, 101, 147, 252, 174, 104, 211, 0, 193, 169, 48, 35, 60, 38, 60, 113, 141, 171, 103, 206, 2, 101, 132, 32, 0, 143, 127, 145, 184, 188, 119, 156, 135, 27, 142, 27, 48, 141, 213, 182, 193, 84, 145, 99, 167, 117, 67, 141, 3, 146, 153, 137, 204, 130, 7, 7, 89, 9, 194, 202, 145, 35, 121, 6, 27, 207, 19, 140, 8, 150, 33, 206, 155, 207, 25, 3, 61, 246, 35, 160, 43, 208, 74, 44, 155, 180, 24, 17, 15, 192, 34, 33, 213, 167, 163, 227, 87, 100, 142, 164, 141, 208, 66, 105, 52, 27, 39, 255, 219, 19, 237, 129, 103, 0, 236, 16, 113, 58, 169, 51, 209, 73, 211, 164, 179, 134, 72, 63, 119, 144, 100, 207, 3, 143, 9, 251, 0, 102, 148, 48, 126, 16, 162, 48, 129, 139, 138, 133, 10, 72, 40, 79, 241, 0, 32, 196, 179, 71, 193, 24, 87, 188, 26, 203, 93, 140, 91, 129, 65, 53, 49, 69, 107, 218, 130, 141, 232, 147, 107, 222, 4, 168, 253, 219, 29, 32, 193, 188, 172, 249, 81, 6, 147, 120, 71, 56, 174, 33, 178, 83, 21, 92, 82, 77, 244, 188, 92, 54, 7, 246, 201, 8, 47, 50, 196, 221, 182, 60, 121, 165, 165, 19, 210, 86, 253, 43, 38, 140, 66, 67, 105, 236, 78, 63, 170, 38, 103, 19, 169, 107, 71, 37, 103, 112, 194, 175, 216, 198, 100, 27, 151, 48, 148, 11, 96, 233, 46, 206, 249, 50, 115, 140, 180, 138, 139, 15, 155, 224, 141, 146, 171, 9, 158, 54, 191, 141, 232, 190, 7, 37, 34, 41, 243, 9, 214, 26, 82, 108, 129, 167, 185, 90, 77, 242, 247, 39, 121, 145, 192, 33, 112, 53, 243, 140, 97, 201, 172, 45, 25, 136, 18, 85, 40, 112, 161, 226, 160, 12, 51, 5, 93, 69, 104, 218, 233, 42, 40, 176, 97, 150, 236, 75, 163, 236, 145, 3, 178, 195, 178, 27, 196, 255, 137, 117, 150, 21, 104, 106, 187, 85, 168, 219, 173, 239, 19, 120, 173, 216, 105, 97, 166, 188, 136, 17, 48, 181, 234, 5, 107, 178, 18, 19, 81, 164, 61, 50, 134, 104, 124, 128, 152, 234, 203, 199, 147, 50, 254, 182, 165, 112, 53, 161, 107, 201, 32, 73, 234, 172, 41, 116, 135, 220, 197, 163, 2, 36, 142, 81, 225, 53, 205, 252, 21, 179, 75, 113, 68, 32, 191, 42, 166, 178, 46, 200, 117, 103, 85, 94, 95, 162, 70, 40, 119, 153, 52, 37, 134, 22, 186, 60, 147, 69, 146, 115, 172, 200, 94, 42, 96, 31, 9, 125, 122, 23, 244, 69, 74, 119, 48, 186, 193, 230, 35, 185, 69, 148, 146, 248, 192, 35, 63, 242, 149, 142, 136, 245, 153, 111, 225, 121, 137, 240, 11, 148, 245, 209, 226, 74, 120, 172, 1, 135, 193, 49, 68, 213, 198, 11, 99, 189, 85, 212, 99, 254, 125, 134, 56, 163, 36, 197, 236, 202, 184, 240, 73, 142, 147, 135, 161, 136, 77, 224, 244, 57, 96, 217, 220, 178, 179, 82, 186, 197, 86, 110, 28, 187, 36, 191, 144, 210, 215, 27, 190, 145, 64, 1, 35, 69, 103, 137, 171, 205, 239};
  int i;
  
  //Alice generates a public key
  // MUPQ_crypto_kem_keypair(pk+8, sk_a+8);
  // To fix the secret key
  // char str[12];
  for (int j = 0; j < MUPQ_CRYPTO_PUBLICKEYBYTES+16; j++) {
    pk[j] = pk_u[j];
    // sprintf(str, "%d", pk[j]);
    // hal_send_str(str);
  }
  //hal_send_str("+++");
  for (int j = 0; j < MUPQ_CRYPTO_SECRETKEYBYTES+16; j++) {
    sk_a[j] = sk_u[j];
    // sprintf(str, "%d", sk_a[j]);
    // hal_send_str(str);
  }
  hal_send_str("DONE key pair generation!");

  for(i=0; i<NTESTS; i++)
  { 
    //Bob derives a secret key and creates a response
    MUPQ_crypto_kem_enc(sendb+8, key_b+8, pk+8);
    hal_send_str("DONE encapsulation!");

    //Alice uses Bobs response to get her secret key
    MUPQ_crypto_kem_dec(key_a+8, sendb+8, sk_a+8);
    hal_send_str("DONE decapsulation!");

    if(memcmp(key_a+8, key_b+8, MUPQ_CRYPTO_BYTES))
    {
      hal_send_str("ERROR KEYS\n");
    }
    else if(check_canary(key_a) || check_canary(key_a+sizeof(key_a)-8) ||
            check_canary(key_b) || check_canary(key_b+sizeof(key_b)-8) ||
            check_canary(pk) || check_canary(pk+sizeof(pk)-8) ||
            check_canary(sendb) || check_canary(sendb+sizeof(sendb)-8) ||
            check_canary(sk_a) || check_canary(sk_a+sizeof(sk_a)-8))
    {
      hal_send_str("ERROR canary overwritten\n");
    }
    else
    {
      hal_send_str("OK KEYS\n");
    }
    hal_send_str("+");
  }
  return 0;
}


static int test_invalid_sk_a(void)
{
  unsigned char sk_a[MUPQ_CRYPTO_SECRETKEYBYTES];
  unsigned char key_a[MUPQ_CRYPTO_BYTES], key_b[MUPQ_CRYPTO_BYTES];
  unsigned char pk[MUPQ_CRYPTO_PUBLICKEYBYTES];
  unsigned char sendb[MUPQ_CRYPTO_CIPHERTEXTBYTES];
  int i;

  for(i=0; i<NTESTS; i++)
  {
    //Alice generates a public key
    MUPQ_crypto_kem_keypair(pk, sk_a);

    //Bob derives a secret key and creates a response
    MUPQ_crypto_kem_enc(sendb, key_b, pk);

    //Replace secret key with random values
    randombytes(sk_a, MUPQ_CRYPTO_SECRETKEYBYTES);

    //Alice uses Bobs response to get her secre key
    MUPQ_crypto_kem_dec(key_a, sendb, sk_a);

    if(!memcmp(key_a, key_b, MUPQ_CRYPTO_BYTES))
    {
      hal_send_str("ERROR invalid sk_a\n");
    }
    else
    {
      hal_send_str("OK invalid sk_a\n");
    }
    hal_send_str("+");
  }

  return 0;
}


static int test_invalid_ciphertext(void)
{
  unsigned char sk_a[MUPQ_CRYPTO_SECRETKEYBYTES];
  unsigned char key_a[MUPQ_CRYPTO_BYTES], key_b[MUPQ_CRYPTO_BYTES];
  unsigned char pk[MUPQ_CRYPTO_PUBLICKEYBYTES];
  unsigned char sendb[MUPQ_CRYPTO_CIPHERTEXTBYTES];
  int i;
  size_t pos;

  for(i=0; i<NTESTS; i++)
  {
    randombytes((unsigned char *)&pos, sizeof(size_t));

    //Alice generates a public key
    MUPQ_crypto_kem_keypair(pk, sk_a);

    //Bob derives a secret key and creates a response
    MUPQ_crypto_kem_enc(sendb, key_b, pk);

    // Change ciphertext to random value
    randombytes(sendb, sizeof(sendb));

    //Alice uses Bobs response to get her secret key
    MUPQ_crypto_kem_dec(key_a, sendb, sk_a);

    if(!memcmp(key_a, key_b, MUPQ_CRYPTO_BYTES))
    {
      hal_send_str("ERROR invalid ciphertext\n");
    }
    else
    {
      hal_send_str("OK invalid ciphertext\n");
    }
    hal_send_str("+");
  }

  return 0;
}

int main(void)
{
  hal_setup(CLOCK_FAST);

  // marker for automated testing
  hal_send_str("==========================");
  test_keys();
  // test_invalid_sk_a();
  // test_invalid_ciphertext();
  hal_send_str("#");

  return 0;
}
